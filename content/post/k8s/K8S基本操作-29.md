---
title: "K8S基本操作-28-備份與還原叢集"
date: 2024-02-04T10:00:44+08:00
draft: false
featured_image: "/k8s.png"
tags: ["K8S"]
---

# 備份的幾種方式

### Velero

可以簡單佈署在 Docker 上的 K8S 備份工具，還有 Web GUI 。

操作簡單功能完整。

此種方式甚至可以把 Volume 一起打包。

(文章撰寫時)是開源免費的。

[https://velero.io/docs/v1.13/](https://velero.io/docs/v1.13/)

### Kubectl 備份法

雖然可以備份許多 Pod, Deployment, Service，雖然無法備份完整的叢集設置與 Volume，但如果影響不大，這種方式仍然是十分方便的。

```bash
kubectl get all --all-namespaces -o yaml > all-deploy-services.yaml
```

只後再編輯`all-deploy-services.yaml`直到可以順利 apply 即可。

### ETCD 備份法

可以備份完整的叢集設置，但無法備份 Volume，但相對上述方式完整些，方法如下。

#### 備份:

```bash
ETCDCTL_API=3 etcdctl snapshot save snapshot.db
```

#### 檢查備份內容:

```bash
etcdctl snapshot status snapshot.db
```

結果:

```
+ + + + ++ + + + ++ + + + ++ + + + ++ + + + + + +
| HASH    | REVISION | TOTAL KEYS | TOTAL SIZE |
+ + + + ++ + + + ++ + + + ++ + + + ++ + + + + + +
| e63b3fc5| 473353   | 875        | 4.1 MB     |
+ + + + ++ + + + ++ + + + ++ + + + ++ + + + + + +
```

#### 重新存回備份

關閉 API Server

```bash
service kube-apiserver stop
```

回復儲存:

```bash
ETCDCTL_API=3 etcdctl \
snapshot restore snapshot.db \
--data-dir /var/lib/etcd-from-backup \
--initial-cluster master-1=https://192.168.5.11:2380,master-2=https://192.168.5.12:2380 \
--initial-cluster-token etcd-cluster-1 \
--initial-advertise-peer-urls https://${INTERNAL_IP}:2380
```

重啟 daemon, API server 與 etcd:

```bash
systemctl daemon-reload
```

```bash
service etcd restart
```

```bash
service kube-apiserver start
```