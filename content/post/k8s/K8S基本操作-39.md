---
title: "K8S基本操作-39-K8S 的權限種類"
date: 2024-02-07T10:50:44+08:00
draft: false
featured_image: "/k8s.png"
tags: ["K8S"]
---

# K8S 的權限種類

## Node

例如每個 Worker Node 都擁有一個權限身份，設置在 kubelet 用來存取 Kube API。

## ABAC (屬性基礎權限控制 Attribute-Based Access Control)

基於屬性的權限身分。

* 屬性：屬性是描述資源、請求和用戶特徵的鍵值對。例如，資源屬性可以包括資源類型、資源名稱、資源命名空間等；請求屬性可以包括請求方法、請求 URL 等；用戶屬性可以包括用戶名稱、用戶角色、用戶組等。

* 策略：策略是定義訪問控制規則的集合。策略通常由以下幾個部分組成：

* 效果：效果可以是允許或拒絕。
* 資源：資源是策略所適用的資源類型。
* 屬性：屬性是策略所使用的屬性。
* 角色：角色是將策略綁定到用戶的集合。

以下為範例:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Policy
metadata:
  name: allow-pods-in-default-namespace
spec:
  allow:
    - effect: Allow
      resources:
        - pods
      namespaces:
        - default
  users:
    - system:serviceaccount:default:default
```

## RBAC (角色基礎權限控制 Role-Based Access Control)

Role-Based Access Control (RBAC) 是一種基於角色的訪問控制模型。在 RBAC 模型中，訪問控制決策是根據用戶的角色來進行的。

* 角色：角色是一組權限的集合。
* 角色綁定：角色綁定是將角色綁定到用戶或組的集合。

這種權限控制要建立兩個 YAML ， 一個是定義角色，一個是把角色綁定在某特定用戶上。

### 範例1

設置一個管理員角色:

*rbac-role.yaml*
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: admin
rules:
  - apiGroups:
      - "*"
    resources:
      - "*"
    verbs:
      - "*"
```

綁定 admin 在用戶 Peter 上

*rbac-rolebinding.yaml*
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: admin-binding
subjects:
  - kind: User
    name: peter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: admin
```

使用以下指令:

```bash
kubectl create -f rbac-role.yaml
kubectl create -f rbac-rolebinding.yaml
```

### 範例2

建立一個可以查看 Pod 的角色:

*rbac-role.yaml*
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: view-pods
rules:
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
```

然後賦予到 Jane 身上

*rbac-rolebinding.yaml*
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: view-pods-binding
subjects:
  - kind: User
    name: jane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: view-pods
```

## Webhook

委託第三方支持 Webhook 的系統進行權限驗證，如: Open Policy Agent。

[https://www.openpolicyagent.org/](https://www.openpolicyagent.org/)

# K8S API Server 負責允許權限種類

K8S API Server 啟動時，需要決定要開啟哪些授權方式，例如以下範例:

```bash
ExecStart=/usr/local/bin/kube-apiserver \\
--advertise-address=${INTERNAL_IP} \\
--allow-privileged=true \\
--apiserver-count=3 \\
--authorization-mode=NODE,RBAC,WEBHOOK \\
--bind-address=0.0.0.0 \\
--enable-swagger-ui=true \\
--etcd-cafile=/var/lib/kubernetes/ca.pem \\
--etcd-certfile=/var/lib/kubernetes/apiserver-etcd-client.crt \\
--etcd-keyfile=/var/lib/kubernetes/apiserver-etcd-client.key \\
--etcd-servers=https://127.0.0.1:2379 \\
--event-ttl=1h \\
--kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\
--kubelet-client-certificate=/var/lib/kubernetes/apiserver-etcd-client.crt \\
--kubelet-client-key=/var/lib/kubernetes/apiserver-etcd-client.key \\
--service-node-port-range=30000-32767 \\
--client-ca-file=/var/lib/kubernetes/ca.pem \\
--tls-cert-file=/var/lib/kubernetes/apiserver.crt \\
--tls-private-key-file=/var/lib/kubernetes/apiserver.key \\
--v=2
```

其中這一段:

```
--authorization-mode=NODE,RBAC,WEBHOOK
```

這代表一個使用者 Node 驗證失敗後，會進行 RBAC 驗證，最後是 WEBHOOK。